<%inherit file="base.html"/>
<%block name="title">ago control device setup</%block>
<script type="text/javascript">
    document._schema = ${schema_json};
    
    var subscription = null;
    var url = "http://" + window.location.hostname + ":8008/jsonrpc";

    function handleEvent(response) {
        if (response.result) { 
            console.log(response.result);
            var states = document.getElementsByClassName("state");
            for (var i = 0; i < states.length; i++) {
                if (states[i].getAttribute("rel") == response.result.uuid) {
                    states[i].innerHTML = response.result.level;
                }
            }
            var slider = document.getElementsByClassName("slider");
            for (var i = 0; i < slider.length; i++) {
                if (slider[i].getAttribute("rel") == response.result.uuid) {
                    if (response.result.level != "-") {
                        $(slider[i]).slider('option', 'disabled', false);
                        $(slider[i]).slider('value', response.result.level);
                    }
                    else {
                        $(slider[i]).slider('option', 'disabled', true);
                    }
                }
            }
            
        }
        getNextEvent();
    }


    function getNextEvent() {
	    var request = {};
	    request.method = "getevent";
	    request.params = {};
	    request.params.uuid = subscription;
	    request.id = 1;
	    request.jsonrpc = "2.0";

	    $.post(url, JSON.stringify(request), handleEvent, "json");
    }


    function subscribe() {
	    var request = {};
	    request.method = "subscribe";
	    request.id = 1;
	    request.jsonrpc = "2.0";

	    $.post(url, JSON.stringify(request), handleSubscribe, "json");
    }
    
    function handleSubscribe(response) {
	    if (response.result) { 
		    subscription = response.result;
		    console.log(subscription);
		   getNextEvent();
	    }
    }
    
    subscribe();

</script>
<div id="devices">
<h2>Device Setup</h2>
<table id="DeviceSetup" class="tablesorter">
<thead> 
    <tr> 
        <th>UUID</th> 
        <th>Device Name</th> 
        <th>Room Name</th> 
        <th>Device Type</th> 
        <th>IntID</th> 
        <th>Value &nbsp;&nbsp;</th> 
        <th>Action</th> 
    </tr> 
<tbody> 
% for device in inventory:
    <tr>
        <td class="uuid">${device["id"]}</td>
        <td class="edit_device" rel="${device["id"]}">${device["name"]}</td>
        <td class="select_device_room" rel="${device["id"]}">${device["roomname"]}</td>
        <td>${device["devicetype"]}</td>
        <td>${device["internalid"]}</td>
        <td class="state" rel="${device["id"]}">${device["state"]}</td>
        <td>${devicetype_commands(device["devicetype"],device["id"],device["state"])}</td>
    </tr>
% endfor
</tbody> 
</table>
</div>

<div id="rooms">
    <h2>Room Setup</h2>
    <table id="RoomSetup" class="tablesorter">
        <thead>
            <tr>
                <th>uuid</th>
                <th>Name</th>
                <th>action</th>
            </tr>
        </thead>
        <tbody>
        % for room in rooms:
            <tr rel="${room["id"]}">
                <td class="uuid">${room["id"]}</td>
                <td class="edit_room" rel="${room["id"]}">${room["name"]}</td>
                <td><button class="delete_room" rel="${room["id"]}">Delete</button></td>
            </tr>
        % endfor
        </tbody>
    </table>
</div>

<div id="modal-command" title="Command Params">
    Test
</div>

<h3>Create Room</h3>
<div class="row">
  <div class="tree columns">
    <dl class="field row">
     <dt class="text">
	<input type="text" name="new_room_name" id="new_room_name" placeholder="Room name" /> 
     </dt>
    </dl>
  </div>
  <div class="one columns">
    <input class="new_room btn" type="button" value="Create Room">
  </div>
</div>

<%def name="devicetype_commands(devicetype,uuid,state)">
% if devicetype in schema["devicetypes"]:
  % for command in schema["devicetypes"][devicetype]["commands"]:
      % if command == "on":
         <button class="switch" command="${command}" rel="${uuid}" state="${state}">${schema["commands"][command]["name"]}</button> 
      % elif command == "off":
         <button class="switch" command="${command}" rel="${uuid}" state="${state}">${schema["commands"][command]["name"]}</button>
      % elif command == "setlevel":
        <div class="slider level" rel="${uuid}" state="${state}"></div>
      % else:
        % if command in schema["commands"]:
            % if command == "setcolor":
              <button class="switch" command="${command}" rel="${uuid}">${schema["commands"][command]["name"]}</button>
              <input class="color" size=8 value="" />
            % elif "parameters" in schema["commands"][command]:
              <button class="command" rel="${uuid}" command="${command}" >${command}</button>
            % else:
              <button class="switch" command="${command}" rel="${uuid}" state="${state}">${schema["commands"][command]["name"]}</button> 
            % endif
    	% endif
      % endif
  % endfor
% endif
</%def>

<%def name="devicetype_commands_values(devicetype)">
% if devicetype in schema["devicetypes"]:
  % for command in schema["devicetypes"][devicetype]["commands"]:
	${command},
  % endfor
% endif
</%def>
