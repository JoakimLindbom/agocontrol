<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                    "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD><title>rpc test</title>
<link href="/js/jquery-ui-timepicker-addon.css" rel="stylesheet"></link>
<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery.ui.all.css" rel="stylesheet"></link>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
<script src="/js/jquery-ui-timepicker-addon.js"></script>
<script src="/js/jquery.chained.js"></script>
<script src="/js/jquery.flot.js"></script>
<SCRIPT>

var url = "/jsonrpc";
var options = {
	lines: { show: true },
    	points: { show: true },
	xaxis: { mode: "time",  timeformat: "%m-%d %H:%M",   minTickSize: [5, "minute"]}
};
var inventory = null;

var inventory = null;

function displayGraph(response) {
 
    if (response.result) { 
	var d1 = []
	for(var id in response.result.values) {
		var unixtime = new Date(id.replace(" ", "T")).getTime()
		d1.push([unixtime, response.result.values[id][0]]);
	}
	console.log(d1)
	$.plot($("#placeholder"), [d1], options);
 }
    else if (response.error) { alert("Search error: " + response.error.message); }
}

function getloggergraph() {
 
	var request = {};
	request.method = "message";
	request.params = {};
	request.params.content = {};
	request.params.content.command = "getloggergraph";
	request.params.content.deviceid = $('#devices option:selected').val();
	request.params.content.start = document.forms.userdata.elements.start.value;
	request.params.content.end = document.forms.userdata.elements.end.value;
	request.params.content.env = $('#environments option:selected').text();
	request.params.content.freq = $('#ticks option:selected').text();
	request.id = 1;
	request.jsonrpc = "2.0";

	document.write("<h1>ago control graph: " + request.params.content.start + " - " + request.params.content.end + "</h1>");
	document.write("<div id=\"placeholder\" style=\"width:600px;height:300px;\"></div>");
	$.post(url, JSON.stringify(request), displayGraph, "json");

}
 

function displayDeviceEnvironments(response) {
 
    if (response.result) { 
	// store global
	DeviceEnvironments = response.result;

	var select_devices = document.getElementById('devices');
	var select_environments = document.getElementById('environments');
	console.log(response.result);
	return;
	for(var id in response.result) {
	    if (inventory.inventory[id] == undefined)
	        continue;
	
		if (inventory.inventory[id] == undefined) continue; 
		select_devices.innerHTML = select_devices.innerHTML + "<option value=\"" + id + "\">" + inventory.inventory[id].name + "</option>";
		var envs = response.result[id].split(",");
		var i = 0;
		var env;
		for (i=0; i<envs.length; i++) {
			env = envs[i];
			select_environments.innerHTML = select_environments.innerHTML + "<option value=\"" + env + "\" class=\"" + id + "\">" + env + "</option>";
		}

	}
	$("#environments").chained("#devices"); /* or $("#series").chainedTo("#mark"); */
	console.log(response.result)
 }
    else if (response.error) { alert("Search error: " + response.error.message); }
}

function getdeviceenvironments() {
	// get inventory first
	getinventory(); 

	var request = {};
	request.method = "message";
	request.params = {};
	request.params.content = {};
	request.params.content.command = "getdeviceenvironments";
	request.id = 1;
	request.jsonrpc = "2.0";
	$.post(url, JSON.stringify(request), displayDeviceEnvironments, "json");
}
 
var inventory = null;
 
function displayInventory(response) {
    // When we already have one do do nothing
    if (inventory != null)
	return;
 
    // When we already have one do do nothing
    if (inventory != null)
        return;
 
    if (response.result) { 
	// store inventory global
	inventory = response.result;

	var inventory_div = document.createElement('div');
	inventory_div.innerHTML = '<br>';
	inventory_div.id = 'inventory_div';
	document.body.appendChild(inventory_div);

	for(var id in response.result.inventory) {
		inventory_div.innerHTML = inventory_div.innerHTML + id +  " " + inventory.inventory[id].name + " (" + inventory.inventory[id].devicetype + ")<br>";
	}
	console.log(response.result)
	
 }
    else if (response.error) { alert("Search error: " + response.error.message); }
}

function getinventory() {

	// When we already have one do do nothing
	if (inventory != null)
		return;
 
    // When we already have one do do nothing
    if (inventory != null)
        return;
 
	var request = {};
	request.method = "message";
	request.params = {};
	request.params.content = {};
	request.params.content.command = "inventory";
	request.id = 1;
	request.jsonrpc = "2.0";

	$.ajax({
	    type: 'POST',
	    url: url,
	    data: JSON.stringify(request),
	    success: displayInventory,
	    dataType: "json",
	    async:false
    });


}
 
$(document).ready(function() {

		getdeviceenvironments();

		$('#start').datetimepicker({
			showSecond: false,
			timeFormat: 'HH:mm:ss',
			dateFormat: 'yy-mm-dd',
			stepHour: 1,
			stepMinute: 5,
			stepSecond: 60

		});
		$('#end').datetimepicker({
			showSecond: false,
			timeFormat: 'HH:mm:ss',
			dateFormat: 'yy-mm-dd',
			stepHour: 1,
			stepMinute: 5,
			stepSecond: 60
		});

});


</SCRIPT>
</HEAD>
<BODY>
<div>
<h1>ago control graph generator</h1>
  <form name="userdata" action="" onsubmit="return getloggergraph();">
	<label>start:</label><input type="text" name="start" id="start" value="" />
	<label>end:</label><input type="text" name="end" id="end" value="" />
	<label>device:</label>
	<select id="devices">
		<option value="">--</option>
	</select>
	<label>environment:</label>
	<select id="environments">
		<option value="">--</option>
	</select>
	<label>ticks:</label>
	<select id="ticks">
		<option value="5Min">5Min</option>
		<option value="10Min">10Min</option>
		<option value="15Min">15Min</option>
		<option value="30Min">30Min</option>
		<option value="1h">1h</option>
	</select>
	<input type="submit" value="Get Graph">
  </form>
</BODY>
</HEAD>
